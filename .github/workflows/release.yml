name: Build and Release Fleet Navigator

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build with Maven (Linux)
        run: mvn -B clean package -DskipTests

      - name: Package Linux distribution
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          DIST_DIR="fleet-navigator-${VERSION}-linux-x64"

          mkdir -p "$DIST_DIR"/bin
          mkdir -p "$DIST_DIR"/native/ocr
          mkdir -p "$DIST_DIR"/native/llama
          mkdir -p "$DIST_DIR"/config

          cp target/fleet-navigator-*.jar "$DIST_DIR/bin/fleet-navigator.jar"

          if [ -d "packaging/linux-x64/ocr" ] && [ "$(ls -A packaging/linux-x64/ocr 2>/dev/null)" ]; then
            cp -r packaging/linux-x64/ocr/* "$DIST_DIR/native/ocr/"
          fi

          if [ -d "packaging/linux-x64/native/llama" ] && [ "$(ls -A packaging/linux-x64/native/llama 2>/dev/null)" ]; then
            cp -r packaging/linux-x64/native/llama/* "$DIST_DIR/native/llama/"
          fi

          if [ -f "config/application-linux.yml" ]; then
            cp config/application-linux.yml "$DIST_DIR/config/application.yml"
          else
            cp src/main/resources/application.properties "$DIST_DIR/config/"
          fi

          printf '#!/bin/bash\nSCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"\ncd "$SCRIPT_DIR"\njava -jar bin/fleet-navigator.jar\n' > "$DIST_DIR/start.sh"
          chmod +x "$DIST_DIR/start.sh"

          tar czf "${DIST_DIR}.tar.gz" "$DIST_DIR"
          mkdir -p dist
          mv "${DIST_DIR}.tar.gz" dist/

      - name: Build DEB package
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          PKG_NAME="fleet-navigator"
          PKG_DIR="${PKG_NAME}_${VERSION}_amd64"

          # DEB-Struktur erstellen
          mkdir -p "$PKG_DIR/DEBIAN"
          mkdir -p "$PKG_DIR/opt/fleet-navigator/bin"
          mkdir -p "$PKG_DIR/opt/fleet-navigator/config"
          mkdir -p "$PKG_DIR/opt/fleet-navigator/native/llama"
          mkdir -p "$PKG_DIR/opt/fleet-navigator/native/ocr"
          mkdir -p "$PKG_DIR/usr/share/applications"
          mkdir -p "$PKG_DIR/usr/share/icons/hicolor/256x256/apps"
          mkdir -p "$PKG_DIR/usr/bin"

          # JAR kopieren
          cp target/fleet-navigator-*.jar "$PKG_DIR/opt/fleet-navigator/bin/fleet-navigator.jar"

          # Konfiguration kopieren
          if [ -f "config/application-linux.yml" ]; then
            cp config/application-linux.yml "$PKG_DIR/opt/fleet-navigator/config/application.yml"
          else
            cp src/main/resources/application.properties "$PKG_DIR/opt/fleet-navigator/config/"
          fi

          # Native Libraries kopieren (falls vorhanden)
          if [ -d "packaging/linux-x64/native/llama" ] && [ "$(ls -A packaging/linux-x64/native/llama 2>/dev/null)" ]; then
            cp -r packaging/linux-x64/native/llama/* "$PKG_DIR/opt/fleet-navigator/native/llama/"
          fi

          # Start-Skript erstellen
          cat > "$PKG_DIR/opt/fleet-navigator/start.sh" << 'STARTEOF'
#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"
java -jar bin/fleet-navigator.jar "$@"
STARTEOF
          chmod +x "$PKG_DIR/opt/fleet-navigator/start.sh"

          # Symlink-Skript fÃ¼r /usr/bin
          cat > "$PKG_DIR/usr/bin/fleet-navigator" << 'BINEOF'
#!/bin/bash
exec /opt/fleet-navigator/start.sh "$@"
BINEOF
          chmod +x "$PKG_DIR/usr/bin/fleet-navigator"

          # Desktop-Eintrag erstellen
          cat > "$PKG_DIR/usr/share/applications/fleet-navigator.desktop" << 'DESKTOPEOF'
[Desktop Entry]
Version=1.0
Type=Application
Name=Fleet Navigator
Comment=Lokale KI fÃ¼r alle
Exec=/opt/fleet-navigator/start.sh
Icon=fleet-navigator
Terminal=false
Categories=Development;Utility;
Keywords=AI;LLM;Chat;
DESKTOPEOF

          # Icon kopieren (falls vorhanden, sonst Platzhalter)
          if [ -f "frontend/public/javafleet-logo.png" ]; then
            cp frontend/public/javafleet-logo.png "$PKG_DIR/usr/share/icons/hicolor/256x256/apps/fleet-navigator.png"
          fi

          # DEBIAN/control erstellen
          cat > "$PKG_DIR/DEBIAN/control" << CONTROLEOF
Package: fleet-navigator
Version: ${VERSION}
Section: utils
Priority: optional
Architecture: amd64
Depends: openjdk-17-jre | openjdk-21-jre | default-jre (>= 17)
Maintainer: JavaFleet <info@javafleet.io>
Description: Fleet Navigator - Lokale KI fÃ¼r alle
 Fleet Navigator ist eine lokale KI-Anwendung mit Web-Interface.
 Features:
  - Chat mit lokalen LLM-Modellen
  - UnterstÃ¼tzung fÃ¼r NVIDIA GPU (CUDA)
  - Auto-Update System
  - Multi-Experten System
Homepage: https://github.com/FranzHerstellJavaFleet/Fleet-Navigator
CONTROLEOF

          # DEBIAN/postinst (nach Installation)
          cat > "$PKG_DIR/DEBIAN/postinst" << 'POSTEOF'
#!/bin/bash
set -e

# Berechtigungen setzen
chmod +x /opt/fleet-navigator/start.sh
chmod +x /usr/bin/fleet-navigator

# Desktop-Datenbank aktualisieren
if command -v update-desktop-database &> /dev/null; then
    update-desktop-database -q /usr/share/applications 2>/dev/null || true
fi

# Icon-Cache aktualisieren
if command -v gtk-update-icon-cache &> /dev/null; then
    gtk-update-icon-cache -q /usr/share/icons/hicolor 2>/dev/null || true
fi

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  Fleet Navigator wurde erfolgreich installiert!            â•‘"
echo "â•‘                                                            â•‘"
echo "â•‘  Starten mit:  fleet-navigator                             â•‘"
echo "â•‘  Oder:         /opt/fleet-navigator/start.sh               â•‘"
echo "â•‘                                                            â•‘"
echo "â•‘  Web-Interface: http://localhost:2025                      â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

exit 0
POSTEOF
          chmod +x "$PKG_DIR/DEBIAN/postinst"

          # DEBIAN/prerm (vor Deinstallation)
          cat > "$PKG_DIR/DEBIAN/prerm" << 'PRERMEOF'
#!/bin/bash
set -e
echo "Fleet Navigator wird entfernt..."
exit 0
PRERMEOF
          chmod +x "$PKG_DIR/DEBIAN/prerm"

          # DEB-Paket bauen
          dpkg-deb --build --root-owner-group "$PKG_DIR"

          # In dist verschieben
          mv "${PKG_DIR}.deb" "dist/fleet-navigator_${VERSION}_amd64.deb"

          echo "DEB-Paket erstellt: dist/fleet-navigator_${VERSION}_amd64.deb"

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux
          path: dist/*

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build with Maven (Windows)
        run: mvn -B clean package -DskipTests

      - name: Package Windows distribution
        shell: pwsh
        run: |
          $version = $env:GITHUB_REF_NAME.TrimStart("v")
          $distDir = "fleet-navigator-$version-windows-x64"

          New-Item -ItemType Directory -Path "$distDir/bin","$distDir/native/ocr","$distDir/native/llama","$distDir/config" -Force | Out-Null

          Copy-Item "target/fleet-navigator-*.jar" "$distDir/bin/fleet-navigator.jar"

          if (Test-Path "packaging/win-x64/ocr/*") {
            Copy-Item "packaging/win-x64/ocr/*" "$distDir/native/ocr/" -Recurse -ErrorAction SilentlyContinue
          }

          if (Test-Path "packaging/win-x64/native/llama/*") {
            Copy-Item "packaging/win-x64/native/llama/*" "$distDir/native/llama/" -Recurse -ErrorAction SilentlyContinue
          }

          if (Test-Path "config/application-windows.yml") {
            Copy-Item "config/application-windows.yml" "$distDir/config/application.yml"
          } else {
            Copy-Item "src/main/resources/application.properties" "$distDir/config/"
          }

          $startScript = "@echo off`r`ncd /d `"%~dp0`"`r`njava -jar bin\fleet-navigator.jar`r`npause"
          $startScript | Out-File -FilePath "$distDir/start.bat" -Encoding ASCII

          $zipPath = "$distDir.zip"
          Compress-Archive -Path "$distDir/*" -DestinationPath $zipPath

          New-Item -ItemType Directory -Path "dist" -ErrorAction SilentlyContinue | Out-Null
          Move-Item $zipPath dist/

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          path: dist/*

  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build with Maven (macOS)
        run: mvn -B clean package -DskipTests

      - name: Package macOS distribution
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          DIST_DIR="fleet-navigator-${VERSION}-macos-arm64"

          mkdir -p "$DIST_DIR"/bin
          mkdir -p "$DIST_DIR"/native/ocr
          mkdir -p "$DIST_DIR"/native/llama
          mkdir -p "$DIST_DIR"/config

          cp target/fleet-navigator-*.jar "$DIST_DIR/bin/fleet-navigator.jar"

          if [ -d "packaging/macos-arm64/ocr" ] && [ "$(ls -A packaging/macos-arm64/ocr 2>/dev/null)" ]; then
            cp -r packaging/macos-arm64/ocr/* "$DIST_DIR/native/ocr/"
          fi

          if [ -d "packaging/macos-arm64/native/llama" ] && [ "$(ls -A packaging/macos-arm64/native/llama 2>/dev/null)" ]; then
            cp -r packaging/macos-arm64/native/llama/* "$DIST_DIR/native/llama/"
          fi

          if [ -f "config/application-macos.yml" ]; then
            cp config/application-macos.yml "$DIST_DIR/config/application.yml"
          else
            cp src/main/resources/application.properties "$DIST_DIR/config/"
          fi

          printf '#!/bin/bash\nSCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"\ncd "$SCRIPT_DIR"\njava -jar bin/fleet-navigator.jar\n' > "$DIST_DIR/start.sh"
          chmod +x "$DIST_DIR/start.sh"

          tar czf "${DIST_DIR}.tar.gz" "$DIST_DIR"
          mkdir -p dist
          mv "${DIST_DIR}.tar.gz" dist/

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-macos
          path: dist/*

  create-release:
    runs-on: ubuntu-latest
    needs:
      - build-linux
      - build-windows
      - build-macos
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List artifacts
        run: find dist -type f

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/**/*.tar.gz
            dist/**/*.zip
            dist/**/*.deb
          generate_release_notes: true
          body: |
            ## Fleet Navigator ${{ github.ref_name }}

            ### Downloads
            | Plattform | Datei | Installation |
            |-----------|-------|--------------|
            | **Linux (x64)** | `.tar.gz` | Entpacken, `./start.sh` |
            | **Linux (DEB)** | `.deb` | `sudo apt install ./fleet-navigator_*.deb` |
            | **Windows (x64)** | `.zip` | Entpacken, `start.bat` |
            | **macOS (ARM64)** | `.tar.gz` | Entpacken, `./start.sh` |

            ### Voraussetzungen
            - Java 17 oder neuer
            - Optional: NVIDIA GPU + CUDA fÃ¼r GPU-Beschleunigung

            ### Erste Schritte
            1. Passende Datei herunterladen
            2. Installieren/Entpacken
            3. Starten
            4. Browser Ã¶ffnen: http://localhost:2025
            5. Beim ersten Start: KI-Modell von Hugging Face herunterladen

            ### DEB-Paket Installation (Ubuntu/Debian)
            ```bash
            sudo apt install ./fleet-navigator_*_amd64.deb
            fleet-navigator
            ```

            ---
            ðŸš¢ Fleet Navigator - Lokale KI fÃ¼r alle
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
