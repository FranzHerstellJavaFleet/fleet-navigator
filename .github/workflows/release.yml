name: Build and Release Fleet Navigator

on:
  push:
    tags:
      - "v*.*.*"    # z.B. v1.0.0 -> lÃ¶st den Workflow aus

jobs:
  # =========================
  # Linux-Build
  # =========================
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build with Maven (Linux)
        run: mvn -B clean package -DskipTests

      - name: Package Linux distribution
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          DIST_DIR="fleet-navigator-${VERSION}-linux-x64"

          mkdir -p "$DIST_DIR"/bin
          mkdir -p "$DIST_DIR"/native/ocr
          mkdir -p "$DIST_DIR"/native/llama
          mkdir -p "$DIST_DIR"/config

          # JAR (mit korrektem Namen)
          cp target/fleet-navigator-*.jar "$DIST_DIR/bin/fleet-navigator.jar"

          # OCR (Tesseract + tessdata) - falls vorhanden
          if [ -d "packaging/linux-x64/ocr" ] && [ "$(ls -A packaging/linux-x64/ocr 2>/dev/null)" ]; then
            cp -r packaging/linux-x64/ocr/* "$DIST_DIR/native/ocr/"
          fi

          # llama.cpp JNI - falls vorhanden
          if [ -d "packaging/linux-x64/native/llama" ] && [ "$(ls -A packaging/linux-x64/native/llama 2>/dev/null)" ]; then
            cp -r packaging/linux-x64/native/llama/* "$DIST_DIR/native/llama/"
          fi

          # Konfiguration
          if [ -f "config/application-linux.yml" ]; then
            cp config/application-linux.yml "$DIST_DIR/config/application.yml"
          else
            cp src/main/resources/application.properties "$DIST_DIR/config/"
          fi

          # Start-Skript erstellen
          cat > "$DIST_DIR/start.sh" << 'EOF'
#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"
java -jar bin/fleet-navigator.jar
EOF
          chmod +x "$DIST_DIR/start.sh"

          # Tarball erzeugen
          tar czf "${DIST_DIR}.tar.gz" "$DIST_DIR"

          mkdir -p dist
          mv "${DIST_DIR}.tar.gz" dist/

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux
          path: dist/*

  # =========================
  # Windows-Build
  # =========================
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build with Maven (Windows)
        run: mvn -B clean package -DskipTests

      - name: Package Windows distribution
        shell: pwsh
        run: |
          $version = $env:GITHUB_REF_NAME.TrimStart("v")
          $distDir = "fleet-navigator-$version-windows-x64"

          New-Item -ItemType Directory -Path "$distDir/bin","$distDir/native/ocr","$distDir/native/llama","$distDir/config" -Force | Out-Null

          # JAR
          Copy-Item "target/fleet-navigator-*.jar" "$distDir/bin/fleet-navigator.jar"

          # OCR - falls vorhanden
          if (Test-Path "packaging/win-x64/ocr/*") {
            Copy-Item "packaging/win-x64/ocr/*" "$distDir/native/ocr/" -Recurse -ErrorAction SilentlyContinue
          }

          # llama.cpp JNI - falls vorhanden
          if (Test-Path "packaging/win-x64/native/llama/*") {
            Copy-Item "packaging/win-x64/native/llama/*" "$distDir/native/llama/" -Recurse -ErrorAction SilentlyContinue
          }

          # Konfiguration
          if (Test-Path "config/application-windows.yml") {
            Copy-Item "config/application-windows.yml" "$distDir/config/application.yml"
          } else {
            Copy-Item "src/main/resources/application.properties" "$distDir/config/"
          }

          # Start-Skript erstellen
          @"
@echo off
cd /d "%~dp0"
java -jar bin\fleet-navigator.jar
pause
"@ | Out-File -FilePath "$distDir/start.bat" -Encoding ASCII

          # ZIP erzeugen
          $zipPath = "$distDir.zip"
          Compress-Archive -Path "$distDir/*" -DestinationPath $zipPath

          New-Item -ItemType Directory -Path "dist" -ErrorAction SilentlyContinue | Out-Null
          Move-Item $zipPath dist/

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          path: dist/*

  # =========================
  # macOS-Build
  # =========================
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Build with Maven (macOS)
        run: mvn -B clean package -DskipTests

      - name: Package macOS distribution
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          DIST_DIR="fleet-navigator-${VERSION}-macos-arm64"

          mkdir -p "$DIST_DIR"/bin
          mkdir -p "$DIST_DIR"/native/ocr
          mkdir -p "$DIST_DIR"/native/llama
          mkdir -p "$DIST_DIR"/config

          # JAR
          cp target/fleet-navigator-*.jar "$DIST_DIR/bin/fleet-navigator.jar"

          # OCR - falls vorhanden
          if [ -d "packaging/macos-arm64/ocr" ] && [ "$(ls -A packaging/macos-arm64/ocr 2>/dev/null)" ]; then
            cp -r packaging/macos-arm64/ocr/* "$DIST_DIR/native/ocr/"
          fi

          # llama.cpp JNI - falls vorhanden
          if [ -d "packaging/macos-arm64/native/llama" ] && [ "$(ls -A packaging/macos-arm64/native/llama 2>/dev/null)" ]; then
            cp -r packaging/macos-arm64/native/llama/* "$DIST_DIR/native/llama/"
          fi

          # Konfiguration
          if [ -f "config/application-macos.yml" ]; then
            cp config/application-macos.yml "$DIST_DIR/config/application.yml"
          else
            cp src/main/resources/application.properties "$DIST_DIR/config/"
          fi

          # Start-Skript erstellen
          cat > "$DIST_DIR/start.sh" << 'EOF'
#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
cd "$SCRIPT_DIR"
java -jar bin/fleet-navigator.jar
EOF
          chmod +x "$DIST_DIR/start.sh"

          # Tarball erzeugen
          tar czf "${DIST_DIR}.tar.gz" "$DIST_DIR"

          mkdir -p dist
          mv "${DIST_DIR}.tar.gz" dist/

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-macos
          path: dist/*

  # =========================
  # Release erstellen
  # =========================
  create-release:
    runs-on: ubuntu-latest
    needs:
      - build-linux
      - build-windows
      - build-macos
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: List artifacts
        run: find dist -type f

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/**/*.tar.gz
            dist/**/*.zip
          generate_release_notes: true
          body: |
            ## Fleet Navigator ${{ github.ref_name }}

            ### Downloads
            - **Linux (x64):** `fleet-navigator-*-linux-x64.tar.gz`
            - **Windows (x64):** `fleet-navigator-*-windows-x64.zip`
            - **macOS (ARM64):** `fleet-navigator-*-macos-arm64.tar.gz`

            ### Erste Schritte
            1. Archiv entpacken
            2. `start.sh` (Linux/macOS) oder `start.bat` (Windows) ausfÃ¼hren
            3. Browser Ã¶ffnen: http://localhost:2025
            4. Beim ersten Start: Modell von Hugging Face herunterladen

            ---
            ðŸš¢ Fleet Navigator - Lokale KI fÃ¼r alle
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
